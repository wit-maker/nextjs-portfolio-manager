# プロジェクトデプロイ手順書

## 1. デプロイ前の準備

### 1.1 基本要件の確認
```bash
# 1. 依存関係のインストールと更新
npm clean-install

# 2. 型チェック
npm run typecheck

# 3. リントチェック
npm run lint

# 4. テストの実行
npm run test
```

### 1.2 プロジェクト固有の確認項目

#### データベース関連
- [ ] Prismaスキーマが最新
- [ ] マイグレーションが適用済み
- [ ] シードデータが正常に動作

```bash
# Prismaの準備
npm run prisma:generate
npm run prisma:migrate
```

#### 認証関連
- [ ] NextAuth.jsの設定確認
- [ ] 環境変数の設定
  - DATABASE_URL
  - NEXTAUTH_SECRET
  - NEXTAUTH_URL

#### API関連
- [ ] サーバーアクションの動作確認
- [ ] APIエンドポイントのテスト
- [ ] レート制限の設定確認

## 2. Vercelデプロイの手順

### 2.1 環境変数の設定
Vercelダッシュボードで以下の環境変数を設定：

```env
# データベース設定
DATABASE_URL="production-database-url"

# 認証設定
NEXTAUTH_SECRET="your-production-secret"
NEXTAUTH_URL="https://your-production-domain.com"

# その他の設定
NODE_ENV="production"
```

### 2.2 デプロイ設定の確認

`vercel.json`の設定（必要な場合）：
```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm clean-install",
  "framework": "nextjs"
}
```

### 2.3 ビルド設定の確認

```json
// package.json
{
  "scripts": {
    "build": "next build",
    "postbuild": "next-sitemap"  // サイトマップ生成が必要な場合
  }
}
```

## 3. デプロイ時の注意点

### 3.1 既知の問題と対処法

1. **TypeScriptエラー**
   - 型定義の確認
   - 非同期コンポーネントの適切な実装
   - APIレスポンス型の確認

2. **ビルドパフォーマンス**
   - 不要なインポートの削除
   - 画像の最適化
   - キャッシュの活用

3. **データベース接続**
   - コネクションプールの設定
   - タイムアウト設定
   - エラーハンドリング

### 3.2 セキュリティ考慮事項

1. **環境変数**
   - 本番環境の値を使用
   - 機密情報の適切な管理
   - アクセス制御の設定

2. **APIセキュリティ**
   - レート制限の設定
   - CORS設定の確認
   - 認証・認可の確認

## 4. デプロイ後の確認

### 4.1 機能確認

- [ ] ページの表示・遷移
- [ ] 認証フロー
- [ ] データの取得・更新
- [ ] エラーページの表示

### 4.2 パフォーマンス確認

- [ ] ページロード時間
- [ ] APIレスポンス時間
- [ ] Lighthouseスコア

### 4.3 モニタリング設定

- [ ] エラーログの確認
- [ ] パフォーマンスメトリクス
- [ ] アラート設定

## 5. ロールバック手順

### 5.1 問題発生時の対応

1. Vercelダッシュボードで前回のデプロイに戻す
2. データベースの状態確認
3. キャッシュのクリア
4. DNSキャッシュの更新待ち

### 5.2 緊急時の連絡体制

- テクニカルリード
- インフラ担当者
- データベース管理者

## 6. 定期的なメンテナンス

### 6.1 週次チェック

- [ ] エラーログの確認
- [ ] パフォーマンスメトリクスの確認
- [ ] セキュリティアップデートの適用

### 6.2 月次チェック

- [ ] 依存パッケージの更新
- [ ] データベースの最適化
- [ ] バックアップの確認

## 7. トラブルシューティング

### 7.1 よくあるエラー

1. **ビルドエラー**
```bash
# キャッシュのクリア
npm clean-install
# 依存関係の更新
npm update
```

2. **型エラー**
```bash
# 型定義の更新
npm run typecheck
```

3. **データベースエラー**
```bash
# マイグレーションの確認
npm run prisma:migrate reset
```

### 7.2 パフォーマンス問題

1. **ページロードが遅い**
   - 画像最適化の確認
   - キャッシュ戦略の見直し
   - バンドルサイズの分析

2. **API遅延**
   - データベースクエリの最適化
   - キャッシュの導入検討
   - N+1問題の解消